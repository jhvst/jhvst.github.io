<!doctype html>
<html>

<head>
    <title>teema</title>
    <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡︎</text></svg>">
    <style>

    html {
      background-size: cover;
    }

    body {
        display: grid;
        gap: 2em;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        height: 100vh;
        margin: 0;
        background: linear-gradient(rgba(0, 0, 0, 0.0), rgba(0, 0, 0, 0.8));
    }

    header {
        display: flex;
        justify-content: space-between;
    }

    header fieldset {
      background-color: rgb(236 240 241 / 50%);
      backdrop-filter: blur(10px);
      border-radius: 7px;
    }

    main {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
   }

    main fieldset {
        border: 0;
        align-self: end;
    }

    textarea {
        height: 50vh;
        width: 90%;
        background-color: rgb(236 240 241 / 50%);
    }

    form#geo input[type="number"] {
        width: 3rem;
    }

    </style>
</head>
<body>

    <header>

        <form onsubmit="geolocate(event); return false" id="geo">
            <fieldset>
                <legend>Geolocation <input type="submit" value="↺" /></legend>
                <input hidden name="latitude" type="number" step="0.01" readonly required />
                <input hidden name="longitude" type="number" step="0.01" readonly required />
                <span id="sunrise">??:??</span>
                <span id="sunset">??:??</span>
                <output id="time">??:??:?? ??</output>
            </fieldset>
        </form>

        <form onsubmit="NTS(event); volumeSet(event.target); return false">
          <fieldset disabled>
            <legend>NTS
              <input onclick="event.target.form.querySelector('fieldset').disabled = false;" type="submit" value="↺">
            </legend>
            <input checked onchange="muteSibling(event); setTitle(event.target.form); setCover(event.target.form);" required type="radio" name="nts" value="nts-1" />
            <audio crossorigin="anonymous" id="nts-1" muted autoplay>
              <source src="https://stream-relay-geo.ntslive.net/stream" />
            </audio>
            <input onchange="muteSibling(event); setTitle(event.target.form); setCover(event.target.form);" required type="radio" name="nts" value="nts-2" />
            <audio crossorigin="anonymous" id="nts-2" muted autoplay>
              <source src="https://stream-relay-geo.ntslive.net/stream2" />
            </audio>
            <input oninput="volumeSet(event.target.form)" type="range" name="volume" min="0" max="1" step="0.05" />
            <input disabled type="button" onclick="muteSibling(event);" value="play" />
            <div>
              <output></output>
            </div>
          </fieldset>
        </form>

    </header>

    <main>

        <fieldset>
            <textarea></textarea>
        </fieldset>

        <fieldset>
            <textarea></textarea>
        </fieldset>

        <fieldset>
            <textarea></textarea>
        </fieldset>

        <fieldset>
            <textarea></textarea>
        </fieldset>

        <fieldset>
            <textarea></textarea>
        </fieldset>

    </main>

</body>

<script>

    document.addEventListener("DOMContentLoaded", event => {
      setInterval(() => document.getElementById("time").textContent = new Date().toLocaleTimeString(), 1000)
    });

    const volumeSet = f => f.querySelectorAll("audio").forEach(a => a.volume = document.querySelector("input[type='range']").value)
    const setCover = e => document.documentElement.style.backgroundImage = `url('${document.getElementById(new FormData(e).get("nts")).dataset.cover}')`
    const setTitle = e => e.querySelector("output").textContent = e.querySelector(":checked").nextElementSibling.dataset.title

    const muteSibling = e => {
      const play = e.type == "click" ? true : false
      if (new Set([...e.target.form.querySelectorAll("audio")].map(a => a.muted)).union(new Set([true])).size == 1 && !play) return;
      const buttons = [...e.target.form.querySelectorAll("input[type='radio']")].map(r => r.checked)
      e.target.form.querySelectorAll("audio").forEach((v, idx) => {
        if (buttons[idx]) {
          v.muted = !v.muted;
        } else {
          v.muted = true
        }
      })
    }

    const NTS = async e => {
      try {
        const req = await fetch("https://www.nts.live/api/v2/live", { cache: "no-store" } );
        const json = await req.json();
        const tracks = e.target.querySelectorAll("audio");
        json.results
          .map((station) => station.now)
          .forEach((v, idx) => {
            tracks[idx].dataset.title = v.broadcast_title;
            tracks[idx].dataset.cover = v.embeds.details.media.background_large;
          })
      } catch (e) {
        console.log(e)
      } finally {
        e.target.querySelector("input[type='button']").disabled = false;
        setCover(e.target)
        setTitle(e.target)
      }
    }

    const geolocate = e => {
        navigator.geolocation.getCurrentPosition(pos => {
            e.target.querySelector("input[name='latitude']").value = parseFloat(pos.coords.latitude).toFixed(2);
            e.target.querySelector("input[name='longitude']").value = parseFloat(pos.coords.longitude).toFixed(2);
            const [sunrise, sunset] = suntimes(pos.coords.latitude, pos.coords.longitude, undefined);
            document.querySelector("#sunrise").innerHTML = parseFloat(sunrise).toFixed(2);
            document.querySelector("#sunset").innerHTML = parseFloat(sunset).toFixed(2);
            localStorage.setItem("latitude", e.target.querySelector("input[name='latitude']").value);
            localStorage.setItem("longitude", e.target.querySelector("input[name='longitude']").value);
        });
    }

    for (let idx = 0; idx < localStorage.length; idx++) {
        const key = localStorage.key(idx);
        const query = `input[name='${key}']`;
        document.querySelector(query).value = localStorage.getItem(key);
    }

    const suntimes = (lat, lng, tz) => {
        var d = new Date();
        var radians = Math.PI / 180.0;
        var degrees = 180.0 / Math.PI;

        var a = Math.floor((14 - (d.getMonth() + 1.0)) / 12)
        var y = d.getFullYear() + 4800 - a;
        var m = (d.getMonth() + 1) + 12 * a - 3;
        var j_day = d.getDate() + Math.floor((153 * m + 2)/5) + 365 * y + Math.floor(y/4) - Math.floor(y/100) + Math.floor(y/400) - 32045;
        var n_star = j_day - 2451545.0009 - lng / 360.0;
        var n = Math.floor(n_star + 0.5);
        var solar_noon = 2451545.0009 - lng / 360.0 + n;
        var M = 356.0470 + 0.9856002585 * n;
        var C = 1.9148 * Math.sin( M * radians ) + 0.02 * Math.sin( 2 * M * radians ) + 0.0003 * Math.sin( 3 * M * radians );
        var L = ( M + 102.9372 + C + 180 ) % 360;
        var j_transit = solar_noon + 0.0053 * Math.sin( M * radians) - 0.0069 * Math.sin( 2 * L * radians );
        var D = Math.asin( Math.sin( L * radians ) * Math.sin( 23.45 * radians ) ) * degrees;
        var cos_omega = ( Math.sin(-0.83 * radians) - Math.sin( lat * radians ) * Math.sin( D * radians ) ) / ( Math.cos( lat * radians ) * Math.cos( D * radians ) );

        // sun never rises
        if( cos_omega > 1)
            return [null, -1];

        // sun never sets
        if( cos_omega < -1 )
            return [-1, null];

        // get Julian dates of sunrise/sunset
        var omega = Math.acos( cos_omega ) * degrees;
        var j_set = j_transit + omega / 360.0;
        var j_rise = j_transit - omega / 360.0;

        /*
        * get sunrise and sunset times in UTC
        * Check section "Finding Julian date given Julian day number and time of
        *  day" on wikipedia for where the extra "+ 12" comes from.
        */
        var utc_time_set = 24 * (j_set - j_day) + 12;
        var utc_time_rise = 24 * (j_rise - j_day) + 12;
        var tz_offset = tz === undefined ? -1 * d.getTimezoneOffset() / 60 : tz;
        var local_rise = (utc_time_rise + tz_offset) % 24;
        var local_set = (utc_time_set + tz_offset) % 24;
        return [local_rise, local_set];
    }

</script>

</html>
